# rjq 要件仕様書

## 1. 概要

**プロジェクト名**: rjq
**バージョン**: 0.1.0
**目的**: JSONデータに対してjaqクエリを実行するインタラクティブなターミナルUIアプリケーション

## 2. 機能要件

### 2.1 JSON データ入力機能 (F001)
- **要件**: 標準入力からJSONデータを読み取る
- **詳細**:
  - パイプまたはリダイレクトによるJSON入力をサポート
  - TTY判定により、パイプ入力と対話モードを自動識別
  - 無効なJSON入力の場合、デフォルトサンプルデータに切り替え
- **実装場所**: `main.rs:189-196` (`read_stdin()`, `main()`)

### 2.2 jaq クエリ実行機能 (F002)
- **要件**: ユーザー入力のjaqクエリをリアルタイムで実行
- **詳細**:
  - jaq-core、jaq-std、jaq-jsonライブラリを使用
  - キーストロークごとにクエリを再実行
  - クエリ結果をJSON形式で出力
- **実装場所**: `main.rs:91-109` (`filter()`)

### 2.3 リアルタイム結果表示機能 (F003)
- **要件**: クエリ結果をリアルタイムで表示更新
- **詳細**:
  - 入力変更時に即座に結果を更新
  - JSON結果の整形表示（pretty print）
  - 複数結果の配列表示サポート
- **実装場所**: `main.rs:59-73` (メインループ内)

### 2.4 ユーザー入力管理機能 (F004)
- **要件**: ユーザーからのキーボード入力を適切に処理
- **詳細**:
  - 文字入力、削除、クリア操作をサポート
  - 特殊キー（Esc、Ctrl+C、Enter、Backspace）の処理
  - 入力状態の維持と管理
- **実装場所**: `main.rs:112-144` (`get_action()`, `update()`)

### 2.5 エラーハンドリング機能 (F005)
- **要件**: 各種エラーを適切に処理し、ユーザーに通知
- **詳細**:
  - JSON解析エラーの処理
  - jaqクエリコンパイルエラーの処理
  - ターミナル操作エラーの処理
- **実装場所**: `main.rs:98-108`, App構造体のerrorフィールド

## 3. 非機能要件

### 3.1 パフォーマンス要件 (NF001)
- **応答性**: キー入力から結果表示まで100ms以内
- **メモリ使用量**: 入力JSONサイズの3倍以下
- **対象データサイズ**: 10MB以下のJSONファイルで快適動作

### 3.2 可用性要件 (NF002)
- **稼働率**: ローカルアプリケーションのため常時利用可能
- **障害処理**: エラー発生時もアプリケーション継続動作
- **復旧機能**: ターミナル状態の確実な復元

### 3.3 保守性要件 (NF003)
- **コード品質**: Rustの標準的なコーディング規約に準拠
- **テストカバレッジ**: 主要機能の単体テストを実装
- **ドキュメント**: 設計書、要件書の整備

### 3.4 移植性要件 (NF004)
- **対応OS**: Linux、macOS、Windows
- **ターミナル**: 標準的なターミナルエミュレータで動作
- **依存関係**: 最小限の外部依存関係

## 4. 技術要件

### 4.1 開発言語・フレームワーク (T001)
- **言語**: Rust (Edition 2024)
- **TUIライブラリ**: ratatui 0.29.0
- **ターミナル制御**: crossterm 0.29.0
- **JSON処理**: serde_json 1.0.142

### 4.2 jaq エンジン要件 (T002)
- **jaq-core**: 2.2.1 - コアクエリエンジン
- **jaq-std**: 2.1.2 - 標準関数ライブラリ
- **jaq-json**: 1.1.3 - JSON特化機能（serde_json feature有効）

### 4.3 システム要件 (T003)
- **TTY検出**: atty 0.2 - パイプ入力判定
- **メモリ安全性**: Rustの型システムによる保証
- **クロスプラットフォーム**: crosstermによる対応

## 5. ユーザーインターフェース要件

### 5.1 レイアウト要件 (UI001)
- **画面構成**: 上部プロンプト行 + 下部結果表示エリア
- **プロンプト**: `"query > "` + ユーザー入力表示
- **結果エリア**: JSON整形結果またはエラーメッセージ表示

### 5.2 キーバインド要件 (UI002)
| キー | 機能 | 実装箇所 |
|------|------|----------|
| `Esc` | アプリケーション終了 | `main.rs:114` |
| `Ctrl+C` | アプリケーション終了 | `main.rs:115` |
| `Enter` | 入力クリア | `main.rs:124` |
| `Backspace` | 一文字削除 | `main.rs:123` |
| `文字キー` | 文字入力 | `main.rs:116-122` |

### 5.3 表示要件 (UI003)
- **カーソル表示**: 入力行末にカーソル表示
- **リアルタイム更新**: キー入力ごとに画面更新
- **エラー表示**: クエリエラー時の適切なメッセージ表示

## 6. データ要件

### 6.1 入力データ (D001)
- **形式**: 有効なJSON文字列
- **ソース**: 標準入力（パイプ、リダイレクト）
- **フォールバック**: デフォルトサンプルJSON

### 6.2 出力データ (D002)
- **形式**: JSON整形出力またはプレーンテキスト
- **出力先**: ターミナル画面（UI表示）
- **エンコーディング**: UTF-8

## 7. セキュリティ要件

### 7.1 入力検証 (S001)
- **JSON検証**: 入力JSONの構文チェック
- **メモリ安全**: Rustによる自動メモリ管理
- **入力サイズ制限**: 実用的なメモリ使用量内での動作

### 7.2 実行環境 (S002)
- **権限**: 標準ユーザー権限で実行
- **ネットワーク**: ネットワーク通信なし（ローカル処理のみ）
- **ファイルアクセス**: 標準入出力のみ使用

## 8. テスト要件

### 8.1 単体テスト (TEST001)
- **対象**: 基本入力処理、UI描画機能
- **実装**: `main.rs:216-286`
- **カバレッジ**: 主要な関数・メソッドをテスト

### 8.2 統合テスト (TEST002)
- **対象**: JSON入力からクエリ実行までの全体フロー
- **方法**: 実際のJSONデータとクエリでのテスト

## 9. 制約事項

### 9.1 技術制約 (C001)
- Rustのコンパイル時間
- jaqクエリの実行時間制限なし（無限ループリスク）
- ターミナルサイズに依存する表示制限

### 9.2 運用制約 (C002)
- 標準入力からのみデータ受信
- ファイル保存機能なし
- 履歴機能なし（現バージョン）

## 10. 将来要件 (Future Requirements)

### 10.1 拡張機能候補
- **F-EXT001**: クエリ履歴機能
- **F-EXT002**: 結果出力ファイル保存
- **F-EXT003**: 構文ハイライト
- **F-EXT004**: 複数ファイル対応
- **F-EXT005**: 設定ファイル対応

この要件仕様書は、現在のコード実装に基づいて作成されており、実際の実装と一致しています。