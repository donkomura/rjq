# rjq 設計書

## プロジェクト概要

`rjq`は、JSONデータに対して`jaq`クエリを実行するインタラクティブなターミナルUIアプリケーションです。標準入力からJSONデータを受け取り、リアルタイムでクエリの結果を表示します。

## アーキテクチャ

### 技術スタック

- **言語**: Rust (Edition 2024)
- **TUI フレームワーク**: ratatui (0.29.0)
- **ターミナル制御**: crossterm (0.29.0)
- **JSON クエリエンジン**: jaq-core, jaq-std, jaq-json
- **JSON 処理**: serde_json (1.0.142)
- **TTY 検出**: atty (0.2)

### システム構成

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│     stdin       │───▶│       rjq        │───▶│    Terminal     │
│   (JSON data)   │    │   Application    │    │  (Interactive   │
└─────────────────┘    │                  │    │      UI)        │
                       │  ┌─────────────┐  │    └─────────────────┘
                       │  │     App     │  │
                       │  │   struct    │  │
                       │  └─────────────┘  │
                       │  ┌─────────────┐  │
                       │  │  jaq Query  │  │
                       │  │   Engine    │  │
                       │  └─────────────┘  │
                       └──────────────────┘
```

## コンポーネント設計

### 1. Action 列挙型

```rust
pub enum Action {
    Quit,           // アプリケーション終了
    Input(char),    // 文字入力
    Backspace,      // バックスペース
    Clear,          // 入力クリア
    None,           // 何もしない
}
```

ユーザーの入力を抽象化し、キーボードイベントをアプリケーションロジックから分離します。

### 2. App 構造体

```rust
struct App {
    prompt: String,           // プロンプト文字列
    input: String,            // ユーザー入力
    exit: bool,               // 終了フラグ
    json_value: serde_json::Value,  // 元のJSONデータ
    filtered_result: String,  // フィルタ結果
    error: Option<io::Error>, // エラー情報
}
```

#### 主要メソッド:
- `new(json_value)`: アプリケーションの初期化
- `run(terminal)`: メインループの実行
- `draw(frame)`: UI描画
- `handle_events(key_event)`: イベント処理
- `filter()`: jaqクエリのコンパイルと実行

### 3. UI レイアウト

```
┌─────────────────────────────────────┐
│ query > [user input]                │ ← プロンプト行
├─────────────────────────────────────┤
│                                     │
│     JSON クエリ結果                  │ ← 結果表示エリア
│     (フォーマット済み)                │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

垂直レイアウトで、上部にプロンプト、下部にJSONクエリ結果を表示します。

## データフロー

### 1. 初期化フロー

```
stdin読み込み → JSON解析 → App初期化 → Terminal初期化
```

### 2. メインループ

```
入力待機 → キーイベント処理 → Action生成 → 状態更新 →
jaqクエリ実行 → 結果更新 → UI再描画 → 入力待機...
```

### 3. jaq クエリ実行フロー

```
ユーザー入力 → File構造体作成 → Loader初期化 →
コンパイル → フィルタ生成 → JSON実行 → 結果取得
```

## キーバインド

| キー | アクション |
|------|------------|
| `Esc` | アプリケーション終了 |
| `Ctrl+C` | アプリケーション終了 |
| `Enter` | 入力クリア |
| `Backspace` | 文字削除 |
| `任意の文字` | 入力に追加 |

## エラーハンドリング

### 1. JSON解析エラー
- 無効なJSONの場合は`InvalidInput`エラーとして処理
- デフォルトのサンプルJSONに切り替え

### 2. jaqクエリエラー
- コンパイルエラーは`io::Error`として変換
- エラー情報をUI上に表示

### 3. ターミナルエラー
- Raw modeの有効化/無効化エラー
- ターミナル状態の復元処理を確実に実行

## テスト設計

### 単体テスト
- `test_basic_input`: 基本的な入力処理のテスト
- `test_render`: UI描画機能のテスト

### テスト対象
- アクション処理ロジック
- UI描画ロジック
- 状態更新ロジック

## セキュリティ考慮事項

- 標準入力からのJSONデータの検証
- メモリ安全性はRustの型システムで保証
- 無限ループの防止（jaqクエリの実行制限）

## パフォーマンス特性

- リアルタイム更新: キーストロークごとにクエリを実行
- メモリ使用量: JSONデータサイズに依存
- レスポンス性: 小中規模のJSONに最適化

## 拡張性

### 将来の機能拡張ポイント
1. **複数ファイル対応**: 複数のJSONファイルの同時処理
2. **履歴機能**: クエリ履歴の保存・呼び出し
3. **構文ハイライト**: jaqクエリの構文強調表示
4. **結果エクスポート**: フィルタ結果のファイル出力
5. **設定ファイル**: キーバインドやテーマのカスタマイズ

### アーキテクチャ拡張
- プラグインシステムの導入
- 設定管理コンポーネントの追加
- 複数ペインのサポート

## 依存関係の理由

| ライブラリ | 用途 | 選択理由 |
|-----------|------|----------|
| `ratatui` | TUI構築 | Rustで最も成熟したTUIライブラリ |
| `crossterm` | ターミナル制御 | クロスプラットフォーム対応 |
| `jaq-*` | JSONクエリ | jq互換のRust実装 |
| `serde_json` | JSON処理 | Rustの標準的なJSONライブラリ |
| `atty` | TTY検出 | パイプ入力の判定 |

この設計により、シンプルでありながら拡張可能なJSONクエリツールを実現しています。